# 定时器

## 0、概述

### 定时器定时原理

使用精准的时基，通过硬件的方式，实现定时功能，定时器核心就是计数器

![image-20241124231840911](.\img\image-20241124231840911.png)

### 定时器分类

![image-20241124231923291](.\img\image-20241124231923291.png)

定时器特性：

![image-20241124232031147](.\img\image-20241124232031147.png)

| 定时器类型 | 主要功能                                                     |
| ---------- | ------------------------------------------------------------ |
| 基本定时器 | 没有输入输出通道，常用作时基，即**定时功能**                 |
| 通用定时器 | 具有多路独立通道，可用于**输入捕获/输出比较**，也可用作时基  |
| 高级定时器 | 除具备通用定时器所有功能外，还具备带**死区控制的互补信号输出**、**刹车输入**等功能（可用于电机控制、数字电源设计等） |

## 1、基本定时器

F1：TIM6/TIM7

​	可用于触发DAC，在更新事件（计数器溢出）时，会产生中断/DMA请求

![image-20241124232403309](.\img\image-20241124232403309.png)

### STM32定时器计数模式及溢出条件

| 计数器模式   | 溢出条件           |
| ------------ | ------------------ |
| 递增计数模式 | CNT==ARR           |
| 递减计数模式 | CNT==0             |
| 中心对齐模式 | CNT==ARR-1、CNT==1 |

![image-20241124232455197](.\img\image-20241124232455197.png)

### 定时器溢出时间计算方法

![image-20241124232543345](.\img\image-20241124232543345.png)

- Tout是定时器溢出时间
- Ft是定时器的时钟源频率
- ARR是自动重装载寄存器的值
- PSC是预分频器寄存器的值

### 配置步骤

![image-20241124232620316](.\img\image-20241124232620316.png)

| 函数                            | 主要寄存器    | 主要功能                             |
| ------------------------------- | ------------- | ------------------------------------ |
| HAL_TIM_Base_Init()             | CR1、ARR、PSC | 初始化定时器基础参数                 |
| HAL_TIM_Base_MspInit()          | 无            | 存放NVIC、CLOCK、GPIO初始化代码      |
| HAL_TIM_Base_Start_IT()         | DIER、CR1     | 使能更新中断并启动计数器             |
| HAL_TIM_IRQHandler()            | SR            | 定时器中断处理公用函数，处理各种中断 |
| HAL_TIM_PeriodElapsedCallback() | 无            | 定时器更新中断回调函数，由用户重定义 |

## 2、通用定时器

在更新事件、触发事件、输入捕获、输出比较时，会产生中断/DMA请求

4个独立通道，可用于：输入捕获、输出比较、输出PWM、单脉冲模式

使用外部信号控制定时器且可实现多个定时器互连的同步电路

支持编码器和霍尔传感器电路等

### 通用定时器框图

![uTools_1732462366645](.\img\uTools_1732462366645.png)

### **计数器时钟源**

![image-20241124233421198](.\img\image-20241124233421198.png)

| 计数器时钟选择类型               | 设置方法                                                   |
| -------------------------------- | ---------------------------------------------------------- |
| 内部时钟(CK_INT)                 | 设置TIMx_SMCR的SMS=000                                     |
| 外部时钟模式1：外部输入引脚(TIx) | 设置TIMx_SMCR的SMS=111                                     |
| 外部时钟模式2：外部触发输入(ETR) | 设置TIMx_SMCR的ECE=1                                       |
| 内部触发输入(ITRx)               | 设置可参考STM32F10xxx参考手册_V10（中文版）.pdf，14.3.15节 |

![image-20241124233510383](.\img\image-20241124233510383.png)

### 外部时钟模式1

![image-20241124233542280](.\img\image-20241124233542280.png)

### 外部时钟模式2

![image-20241124233602137](.\img\image-20241124233602137.png)

### 使用一个定时器作为另一个定时器的预分频器（F1为例）

![image-20241124233637685](.\img\image-20241124233637685.png)