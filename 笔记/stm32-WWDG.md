# 窗口看门狗（WWDG）

## 为什么要窗口看门狗		

​		对于一般的看门狗，程序可以在它产生复位前的任意时刻刷新看门狗，但这有一个隐患，有可能程序跑乱了又跑回到正常的地方，或跑乱的程序正好执行了刷新看门狗操作，这样的情况下一般的看门狗就检测不出来了；

   	 如果使用窗口看门狗，程序员可以根据程序正常执行的时间设置刷新看门狗的一个时间窗口，保证不会提前刷新看门狗也不会滞后刷新看门狗，这样可以检测出程序没有按照正常的路径运行非正常地跳过了某些程序段的情况





​	之所以称为窗口就是因为其喂狗时间是一个**有上下限的范围内(窗口）**，你可以通过设定相关寄存器，设定其上限时间（下限固定）。**喂狗的时间不能过早也不能过晚**。而**独立看门狗限制喂狗时间在0-x内**，x由相关寄存器决定。喂狗的时间不能过晚



窗口看门狗工作示意图：

![image-20241119172040828](.\img\image-20241119172040828.png)

![image-20241119172100406](.\img\image-20241119172100406.png)



​		WWDG_CFR（用来配置WWDG,以及窗口值）会与WWDG_CR（WWDG计数器）比较，若CR大于CFR则比较器结果为1（判定是否处于窗口期），且还要写入CR（喂狗），这样与门才会输出1。

​		但若不及时喂狗，在计数器的数值从0x40(1 000 000)减到0x3F(0 111 111)时（T6位跳变到0），比较器就会输出0，故只有在窗口期内喂狗才能不产生复位

​		**WDGA由软件置1，但仅能由硬件在复位后清'0'.WDGA=1时，看门狗可以产生复位**

## 窗口看门狗工作过程总结

STM32F的窗口看门狗中有一个7位的递减计数器T[6:0]，它会在出现下述2种情况之一时产生看门狗复位：

①当喂狗的时候如果**计数器的值大于某一设定数值W[6:0]时**，此设定数值在WWDG_CFR寄存器定义。

② 当计数器的数值从0x40减到0x3F时【**T6位跳变到0**】 。

如果启动了看门狗并且允许中断，当递减计数器等于0x40时产生早期唤醒中断（EWI),它可以用于喂狗以避免WWDG复位。



## u窗口看门狗超时时间

![image-20241119175646776](.\img\image-20241119175646776.png)

![image-20241119172959681](.\img\image-20241119172959681.png)



### 窗口看门狗其他注意事项：

① 上窗口值W[6:0]必须大于下窗口值0x40。否则就无窗口了。

② 窗口看门狗时钟来源PCLK1（APB1总线时钟）分频后。



### 窗口看门狗配置过程

① 使能看门狗时钟：

   *RCC_APB1PeriphClockCmd();*

② 设置分频系数：

   *WWDG_SetPrescaler**();*

③ 设置上窗口值：

   *WWDG_SetWindowValue**();*

④ 开启提前唤醒中断并分组(可选)：

   *WWDG_EnableIT**();* 

   *NVIC_Init**();*

⑤ 使能看门狗：

   *WWDG_Enable**();*

⑥ 喂狗:

  *WWDG_SetCounter**();*

⑦编写中断服务函数

  *WWDG_IRQHandler**();*





# HAL窗口看门狗

![image-20241120233439293](.\img\image-20241120233439293.png)

![image-20241120233953558](.\img\image-20241120233953558.png)

![image-20241120234104907](.\img\image-20241120234104907.png)