## **独立看门狗概述**



### 为什么要看门狗？

​		在由单片机构成的微型计算机系统中，由于单片机的工作常常会受到来自**外界电磁场的干扰**，造成程序的跑飞，而陷入死循环，程序的正常运行被打断，由单片机控制的系统无法继续工作，会造成整个系统的陷入停滞状态，发生不可预料的后果，所以出于对单片机运行状态进行**实时监测**的考虑，便产生了一种**专门用于监测单片机程序运行状态的模块或者芯片**，俗称“看门狗”(watchdog) 

### 看门狗解决的问题是什么？

​		在启动正常运行的时候，系统不能复位。在系统跑飞（程序异常执行）的情况，系统复位，程序重新执行



# 概述

​		STM32内置两个看门狗，提供了更高的安全性，时间的精确性和使用的灵活性。两个看门狗设备（独立看门狗/窗口看门狗)可以用来检测和解决由软件错误引起的故障。**当计数器达到给定的超时值时，触发一个中断（仅适用窗口看门狗）或者产生系统复位。**

​		独立看门狗（IWDG)由专用的**低速时钟（LSI)驱动**，即使主时钟发生 故障它仍有效。

​		独立看门狗适合应用于需要看门狗作为一个**在主程序之外能够完全独立工作**，并且对**时间精度要求低**的场合。

​		窗口看门狗由从**APB1时钟分频后得到时钟驱动**。通过可配置的时间窗口来检测应用程序非正常的过迟或过早操作。窗口看门狗最适合那些要求看门狗在**精确计时**窗口起作用的程序。



### **独立看门狗功能描述**

​		在键值寄存器（IWDG_KR)中写入**0xCCCC**，开始启用独立看门狗。此时计数器开始从其复位值0xFFF递减，当计数器值计数到尾值0x000时会产生一个复位信号（IWDG_RESET)。

​		无论何时，只要在键值寄存器IWDG_KR中写入**0xAAAA**（通常说的喂狗）, 自动重装载寄存器IWDG_RLR的值就会重新加载到计数器，从而避免看门狗复位。如果程序异常，就无法正常喂狗，从而系统复位。

​		**启用iwdg后，LSI时钟会自动开启**

### 

## 内部原理

![image-20241119173857438](.\img\image-20241119173857438.png)

![image-20241119174348972](.\img\image-20241119174348972.png)

![image-20241119174128294](.\img\image-20241119174128294.png)

### 溢出时间计算

溢出时间计算：

分频计算：

pr = 4×*2^prer（具体如上图）

低速时钟LSI = 40K

  *Tout=((4**×**2^prer)* *×**rlr**) /40* （M3)

​		T = 40/pr 

​		---->   f = pr/40 = 	(4**×**2^prer)/40(频率等于周期的倒数，即时钟完成一次计数的时间) 

​		---->  Tout = rlr×*f  = ((4×2^prer)*×rlr) /40	(rlr为计数器里的值，乘以计数器值即为完成给定计数所需时间)

时钟频率LSI=40K， 一个看门狗时钟周期就是最短超时时间。最长超时时间= (IWDG_RLR寄存器最大值）X看门狗时钟周期



# 独立看门狗操作使用

## 库函数的配置

### IWDG独立看门狗操作库函数

void IWDG_WriteAccessCmd(uint16_t IWDG_WriteAccess);//取消写保护：0x5555使能

void IWDG_SetPrescaler(uint8_t IWDG_Prescaler);//设置预分频系数：写PR

void IWDG_SetReload(uint16_t Reload);//设置重装载值：写RLR

void IWDG_ReloadCounter(void);//喂狗：写0xAAAA到KR

void IWDG_Enable(void);//使能看门狗：写0xCCCC到KR

FlagStatus IWDG_GetFlagStatus(uint16_t IWDG_FLAG);//状态：重装载/预分频 更新

### 独立看门狗操作步骤

**① 取消寄存器写保护：**

   ***IWDG_WriteAccessCmd**();***

**② 设置独立看门狗的预分频系数，确定时钟:**

   ***IWDG_SetPrescaler**();***

**③ 设置看门狗重装载值，确定溢出时间:**

  ***IWDG_SetReload**();***

**④ 使能看门狗**

  ***IWDG_Enable**();***

**⑤ 应用程序喂狗:**

  ***IWDG_ReloadCounter**();***



**溢出时间计算：**

  ***Tout=((4×2^prer)* *×rlr) /40* *（**M3)***

## hal库配置

① HAL_IWDG_Init() 取消PR/RLR寄存器写保护，设置IWDG 预分频系数和重装载值，启动IWDG

② HAL_IWDG_Refresh() 及时喂狗，即写入0xAAAA 到IWDG_KR

![image-20241119175302215](.\img\image-20241119175302215.png)