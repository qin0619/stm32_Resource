# NVIC

![image-20241116210639057](.\img\image-20241116210639057.png)

中断流程如上

NVIC支持：256个中断（16内核 + 240外部），支持：256个优先级，允许裁剪！



## **中断向量表**

定义一块固定的内存，以4字节对齐，存放各个中断服务函数程序的首地址

中断向量表定义在启动文件（startup_stm32f10x_hd.s），当发生中断，CPU会自动执行对应的中断服务函数



## 相关寄存器

| NVIC相关寄存器                        | 位数 | 寄存器个数 | 备注                                  |
| ------------------------------------- | ---- | ---------- | ------------------------------------- |
| 中断使能寄存器（ISER）                | 32   | 8          | 每个位控制一个中断                    |
| 中断除能寄存器（ICER）                | 32   | 8          | 每个位控制一个中断                    |
| 应用程序中断及复位控制寄存器（AIRCR） | 32   | 1          | 位[10:8]控制优先级分组                |
| 中断优先级寄存器（IPR）               | 8    | 240        | 8个位对应一个中断，而STM32只使用高4位 |



## 工作原理

![image-20241116210912901](.\img\image-20241116210912901.png)



## 中断优先级

1，抢占优先级(pre)：高抢占优先级可以打断正在执行的低抢占优先级中断

2，响应优先级(sub)：当抢占优先级相同时，响应优先级高的先执行，但是不能互相打断

3，抢占和响应都相同的情况下，自然优先级越高的，先执行

4，自然优先级：中断向量表的优先级

5，数值越小，表示优先级越高



## NVIC的使用

![image-20241116211034889](.\img\image-20241116211034889.png)

# EXIT

External(Extended) interrupt/event Controller，外部(扩展)中断事件控制器，包含20个产生事件/中断请求的边沿检测器，即总共：20条EXTI线（F1）

**中断和事件的理解：**

中断：要进入NVIC，有相应的中断服务函数，需要CPU处理

事件：不进入NVIC，仅用于内部硬件自动控制的，如：TIM、DMA、ADC

## 工作原理

![image-20241116211157662](.\img\image-20241116211157662.png)

![image-20241116211224515](.\img\image-20241116211224515.png)



## AFIO

Alternate Function IO，即复用功能IO，主要用于重映射和外部中断映射配置

特别注意：配置AFIO寄存器之前要使能AFIO时钟，方法如下：

__HAL_RCC_AFIO_CLK_ENABLE();   对应RCC_APB2ENR寄存器 位0

![image-20241116211315496](.\img\image-20241116211315496.png)



# 中断使用流程

![](.\img\image-20241116211343832.png)

![image-20241116211408065](.\img\image-20241116211408065.png)

![image-20241116211437599](.\img\image-20241116211437599.png)

![image-20241116211451219](.\img\image-20241116211451219.png)